# group_by(x, y, month) %>%
mutate(diff_obsSmean       = obs - obs_mean                  , diff_simSmean = sim - sim_mean ) %>%      # diff sat - Long term mean # diff ERA5 - LT mean
mutate(z_score_obs         = diff_obsSmean/obs_sd            , z_score_sim = diff_simSmean/sim_sd )  %>% # z-score of obs and sim from LT mean
mutate(scaled_diff_simSobs = (diff_simSobs)/sd_diff_simSobs)   %>%                           # difference between (ERA5-sat) scaled by the variation in ERA5-satellite
mutate(diff_simSobsSmean   = (diff_simSobs - diff_simSobs_mean) ) %>%                        # difference between (ERA5-sat) and (sat-ERA5 LT mean)
mutate(z_score_simSobs     = diff_simSobsSmean/sd_diff_simSobs )                             # z-score of (ERA5-sat) in heatwave  - is this month an especially large ERA5-satellite variation
dim(df_vars)
df_year$variable <- variable_i
if (0 %in% dim(df_vars)){ df_vars <- df_year }
else{ df_vars <- rbind(df_vars, df_year ) }
df_year
source('~/work/workspace/f4p-era5-analysis/code/figures_for_paper/plot_heatwaves.R')
source('~/work/workspace/f4p-era5-analysis/code/data_preparation/prepare___caseStudies.R', echo=TRUE)
source('~/work/workspace/f4p-era5-analysis/code/figures_for_paper/plot_heatwaves.R', echo=TRUE)
df_subsetHW <- df_comb %>%
filter(x >= hw_bbox$xmin & x <= hw_bbox$xmax) %>%
filter(y >= hw_bbox$ymin & y <= hw_bbox$ymax)
load('data/figures_for_paper/hwAll_gislayers.RData')   # <---- hw_polygons
# input files are the 'df_comb___var.RData' produced by Greg's script
input_dir <- 'data/inter_data/df_comb_obs_vs_sim/'
# list of variables to run over
var_list <- c('LAI', 'LST',  'E', 'albedo_wsa_vis') # albedo_bsa_nir albedo_bsa_vis albedo_wsa_nir 'SM',
output_path <- 'data/figures_for_paper/'
print(paste0('output_path is : ', output_path ))
if(!dir.exists(output_path)) {dir.create(paste0(output_path), recursive = T)}
df_hw <- data.frame(row.names = c("hw2003", "hw2010", "hw2018"),
year = c(2003, 2010, 2018),
month = c(8, 7, 7))
hw_bbox <- hw_polygons %>% filter(hw == 'hw2003') %>% st_bbox()
i <- 1
# for (i in 1:length(var_list)){
variable_i <- var_list[i] ; print(variable_i)
input_file <- paste0('df_comb___',variable_i,'.RData')
load(paste0(input_dir, input_file))
df_subsetHW <- df_comb %>%
filter(x >= hw_bbox$xmin & x <= hw_bbox$xmax) %>%
filter(y >= hw_bbox$ymin & y <= hw_bbox$ymax)
head(df_subsetHW)
df_subset_ts <- df_subsetHW %>%
mutate(time = as.Date(paste(year, month, '15', sep = '-'), '%Y-%M-%d')) %>%
#filter(x == -125.125, y == 72.375) %>%  #  <---- need to replace this...
group_by(time) %>%
summarise(obs = mean(obs, na.rm = T), sim = mean(sim, na.rm = T))
head(df_subset_ts)
df_subset_ts <- df_subsetHW  %>%
#filter(x == -125.125, y == 72.375) %>%  #  <---- need to replace this...
group_by(year, month) %>%
summarise(obs = mean(obs, na.rm = T), sim = mean(sim, na.rm = T))
df_subset_ts <- df_subsetHW  %>%
#filter(x == -125.125, y == 72.375) %>%  #  <---- need to replace this...
group_by(year, month) %>%
summarise(obs = mean(obs, na.rm = T), sim = mean(sim, na.rm = T)) %>%
mutate(time = as.Date(paste(year, month, '15', sep = '-'), '%Y-%M-%d'))
df_subset_ts
ts_all <- ts %>%
group_by(month) %>%
summarise(clim_obs = mean(obs),
clim_sim = mean(sim)) %>%
left_join(ts %>% filter(year %in% c(2003, 2010, 2018)), by = "month") %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
ts_all <- ts %>%
group_by(month) %>%
summarise(clim_obs = mean(obs),
clim_sim = mean(sim)) %>%
left_join(ts %>% filter(year %in% c(2003, 2010, 2018)), by = "month") %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
ts_all <- df_subset_ts %>%
group_by(month) %>%
summarise(clim_obs = mean(obs),
clim_sim = mean(sim)) %>%
left_join(ts %>% filter(year %in% c(2003, 2010, 2018)), by = "month") %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
head(df_subset_ts)
ts_all <- df_subset_ts %>%
group_by(month) %>%
summarise(clim_obs = mean(obs),
clim_sim = mean(sim)) %>%
left_join(df_subset_ts %>% filter(year %in% c(2003, 2010, 2018)), by = "month") %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
ts_all
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0))
i <- 2
# for (i in 1:length(var_list)){
variable_i <- var_list[i] ; print(variable_i)
input_file <- paste0('df_comb___',variable_i,'.RData')
load(paste0(input_dir, input_file))
df_subsetHW <- df_comb %>%
filter(x >= hw_bbox$xmin & x <= hw_bbox$xmax) %>%
filter(y >= hw_bbox$ymin & y <= hw_bbox$ymax)
rm(df_comb)
df_subset_ts <- df_subsetHW  %>%
#filter(x == -125.125, y == 72.375) %>%  #  <---- need to replace this...
group_by(year, month) %>%
summarise(obs = mean(obs, na.rm = T), sim = mean(sim, na.rm = T)) %>%
mutate(time = as.Date(paste(year, month, '15', sep = '-'), '%Y-%M-%d'))
ts_all <- df_subset_ts %>%
group_by(month) %>%
summarise(clim_obs = mean(obs),
clim_sim = mean(sim)) %>%
left_join(df_subset_ts %>% filter(year %in% c(2003, 2010, 2018)), by = "month") %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0))
i <- 3
# for (i in 1:length(var_list)){
variable_i <- var_list[i] ; print(variable_i)
input_file <- paste0('df_comb___',variable_i,'.RData')
load(paste0(input_dir, input_file))
df_subsetHW <- df_comb %>%
filter(x >= hw_bbox$xmin & x <= hw_bbox$xmax) %>%
filter(y >= hw_bbox$ymin & y <= hw_bbox$ymax)
rm(df_comb)
df_subset_ts <- df_subsetHW  %>%
#filter(x == -125.125, y == 72.375) %>%  #  <---- need to replace this...
group_by(year, month) %>%
summarise(obs = mean(obs, na.rm = T), sim = mean(sim, na.rm = T)) %>%
mutate(time = as.Date(paste(year, month, '15', sep = '-'), '%Y-%M-%d'))
ts_all <- df_subset_ts %>%
group_by(month) %>%
summarise(clim_obs = mean(obs),
clim_sim = mean(sim)) %>%
left_join(df_subset_ts %>% filter(year %in% c(2003, 2010, 2018)), by = "month") %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0))
ts_all <- df_subset_ts %>%
group_by(month) %>%
summarise(clim_obs = mean(obs, na.rm = T),
clim_sim = mean(sim, na.rm = T)) %>%
left_join(df_subset_ts %>% filter(year %in% c(2003, 2010, 2018)), by = "month") %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0))
df_subsetHW
df_hw <- data.frame(row.names = c("hw2003", "hw2010", "hw2018"),
year = c(2003, 2010, 2018),
month = c(8, 7, 7))
df_hw
hw_bbox <- hw_polygons %>% filter(hw == 'hw2003') %>% st_bbox()
hw_bbox
bind_cols(
hw_polygons %>% filter(hw == 'hw2003') %>% st_bbox(),
hw_polygons %>% filter(hw == 'hw2010') %>% st_bbox(),
hw_polygons %>% filter(hw == 'hw2018') %>% st_bbox())
hw_polygons %>% filter(hw == 'hw2003') %>% st_bbox()
bind_cols(
hw_polygons %>% filter(hw == 'hw2003') %>% st_bbox(),
hw_polygons %>% filter(hw == 'hw2010') %>% st_bbox(),
hw_polygons %>% filter(hw == 'hw2018') %>% st_bbox())
bind_rows(
hw_polygons %>% filter(hw == 'hw2003') %>% st_bbox(),
hw_polygons %>% filter(hw == 'hw2010') %>% st_bbox(),
hw_polygons %>% filter(hw == 'hw2018') %>% st_bbox())
hw_polygons %>% filter(hw == 'hw2003') %>% st_bbox() %>% as.vector()
hw_polygons
hw_polygons %>% filter(hw == 'hw2003') %>% st_bbox()
hw_polygons
hw_polygons[1]
bind_rows(
hw_polygons %>% filter(hw == 'hw2003') %>% st_bbox() %>% as.vector(),
hw_polygons %>% filter(hw == 'hw2010') %>% st_bbox() %>% as.vector(),
hw_polygons %>% filter(hw == 'hw2018') %>% st_bbox() %>% as.vector())
hw_polygons %>% filter(hw == 'hw2003') %>% st_bbox() %>% as.vector()
hw_polygons %>% filter(hw == 'hw2010') %>% st_bbox() %>% as.vector()
hw_bbox <- hw_polygons %>% filter(hw == 'hw2003') %>% st_bbox()
hw_bbox
df_hw
rownames(df_hw)
varname <- 'LAI'
hwname <- 'hw2003'
varname <- 'LAI'
hw_bbox <- hw_polygons %>% filter(hw == hwname) %>% st_bbox()
df_subsetHW <- df_comb %>%
filter(x >= hw_bbox$xmin & x <= hw_bbox$xmax) %>%
filter(y >= hw_bbox$ymin & y <= hw_bbox$ymax)
get_hw_spatial_average <- function(hwname, varname){
hw_bbox <- hw_polygons %>% filter(hw == hwname) %>% st_bbox()
load(input_dir, paste0('df_comb___', varname, '.RData'))  # <--- df_comb
df_subsetHW <- df_comb %>%
filter(x >= hw_bbox$xmin & x <= hw_bbox$xmax) %>%
filter(y >= hw_bbox$ymin & y <= hw_bbox$ymax)
rm(df_comb)
df_subset_ts <- df_subsetHW  %>%
group_by(year, month) %>%
summarise(obs = mean(obs, na.rm = T), sim = mean(sim, na.rm = T)) %>%
mutate(time = as.Date(paste(year, month, '15', sep = '-'), '%Y-%M-%d'))
return(df_subset_ts)
}
df_subset_ts <- get_hw_spatial_average(hwname = 'hw2003', varname = 'LAI')
get_hw_spatial_average <- function(hwname, varname){
hw_bbox <- hw_polygons %>% filter(hw == hwname) %>% st_bbox()
load(input_dir, paste0('df_comb___', varname, '.RData'))  # <--- df_comb
df_subsetHW <- df_comb %>%
filter(x >= hw_bbox$xmin & x <= hw_bbox$xmax) %>%
filter(y >= hw_bbox$ymin & y <= hw_bbox$ymax)
rm(df_comb)
df_subset_ts <- df_subsetHW  %>%
group_by(year, month) %>%
summarise(obs = mean(obs, na.rm = T), sim = mean(sim, na.rm = T)) %>%
mutate(time = as.Date(paste(year, month, '15', sep = '-'), '%Y-%M-%d'))
return(df_subset_ts)
}
df_subset_ts <- get_hw_spatial_average(hwname = 'hw2003', varname = 'LAI')
hw_bbox <- hw_polygons %>% filter(hw == hwname) %>% st_bbox()
load(input_dir, paste0('df_comb___', varname, '.RData'))  # <--- df_comb
varname
hwname <- 'hw2003'
varname <- 'LAI'
get_hw_spatial_average <- function(hwname, varname){
hw_bbox <- hw_polygons %>% filter(hw == hwname) %>% st_bbox()
load(paste0(input_dir, 'df_comb___', varname, '.RData'))  # <--- df_comb
df_subsetHW <- df_comb %>%
filter(x >= hw_bbox$xmin & x <= hw_bbox$xmax) %>%
filter(y >= hw_bbox$ymin & y <= hw_bbox$ymax)
rm(df_comb)
df_subset_ts <- df_subsetHW  %>%
group_by(year, month) %>%
summarise(obs = mean(obs, na.rm = T), sim = mean(sim, na.rm = T)) %>%
mutate(time = as.Date(paste(year, month, '15', sep = '-'), '%Y-%M-%d'))
return(df_subset_ts)
}
df_subset_ts <- get_hw_spatial_average(hwname = 'hw2003', varname = 'LAI')
head(df_subset_ts)
df_subset_ts <- df_subsetHW  %>%
group_by(year, month) %>%
summarise(obs = mean(obs, na.rm = T), sim = mean(sim, na.rm = T)) %>%
mutate(time = as.Date(paste(year, month, '15', sep = '-'), '%Y-%M-%d'),
varname = varname,
hwname = hwname)
df_subset_ts
get_hw_spatial_average <- function(hwname, varname){
hw_bbox <- hw_polygons %>% filter(hw == hwname) %>% st_bbox()
load(paste0(input_dir, 'df_comb___', varname, '.RData'))  # <--- df_comb
df_subsetHW <- df_comb %>%
filter(x >= hw_bbox$xmin & x <= hw_bbox$xmax) %>%
filter(y >= hw_bbox$ymin & y <= hw_bbox$ymax)
rm(df_comb)
df_subset_ts <- df_subsetHW  %>%
group_by(year, month) %>%
summarise(obs = mean(obs, na.rm = T), sim = mean(sim, na.rm = T)) %>%
mutate(time = as.Date(paste(year, month, '15', sep = '-'), '%Y-%M-%d'),
varname = varname,
hwname = hwname)
return(df_subset_ts)
}
df_subset_ts <- get_hw_spatial_average(hwname = 'hw2003', varname = 'LAI')
gc()
get_hw_spatial_average <- function(hwname, varname){
load(paste0(input_dir, 'df_comb___', varname, '.RData'))  # <--- df_comb
hw_bbox <- hw_polygons %>% filter(hw == hwname) %>% st_bbox()
df_subsetHW <- df_comb %>%
filter(x >= hw_bbox$xmin & x <= hw_bbox$xmax) %>%
filter(y >= hw_bbox$ymin & y <= hw_bbox$ymax)
rm(df_comb)
df_subset_ts <- df_subsetHW  %>%
group_by(year, month) %>%
summarise(obs = mean(obs, na.rm = T), sim = mean(sim, na.rm = T)) %>%
mutate(time = as.Date(paste(year, month, '15', sep = '-'), '%Y-%M-%d'),
varname = varname,
hwname = hwname)
return(df_subset_ts)
}
df_subset_2 <- get_hw_spatial_average(hwname = 'hw2010', varname = 'LAI')
df_subset_3 <- get_hw_spatial_average(hwname = 'hw2018', varname = 'LAI')
df_subset_1 <- get_hw_spatial_average(hwname = 'hw2003', varname = 'LAI')
df_subset_ts <- bind_rows(df_subset_1, df_subset_2, df_subset_3)
head(df_subset_ts)
ts_all <- df_subset_ts %>%
group_by(month, hwname) %>%
summarise(clim_obs = mean(obs, na.rm = T),
clim_sim = mean(sim, na.rm = T))
ts_all
hw_clim_ts <- df_subset_ts %>%
group_by(month, hwname) %>%
summarise(clim_obs = mean(obs, na.rm = T),
clim_sim = mean(sim, na.rm = T))
head(df_subset_ts)
df_subset_ts[,1]
df_subset_ts[1,]
df_subset_ts %>% filter(hwname == paste0(hw, year))
df_subset_ts %>% filter(hwname == paste0('hw', year))
hw_clim_ts
df_all <- df_subset_ts %>%
filter(hwname == paste0('hw', year)) %>%
left_join(hw_clim_ts, by = c('month', 'hwname'))
head(df_all)
ts_all <- df_subset_ts %>%
filter(hwname == paste0('hw', year)) %>%
left_join(hw_clim_ts, by = c('month', 'hwname'))
df_all <- df_subset_ts %>%
filter(hwname == paste0('hw', year)) %>%
left_join(hw_clim_ts, by = c('month', 'hwname')) %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0))
df_subset_ts %>%
filter(hwname == paste0('hw', year)) %>%
left_join(hw_clim_ts, by = c('month', 'hwname'))
df_subset_ts %>%
filter(hwname == paste0('hw', year)) %>%
left_join(hw_clim_ts, by = c('month', 'hwname')) %>%
rename(year_of_hw = year)
df_all <- df_subset_ts %>%
filter(hwname == paste0('hw', year)) %>%
left_join(hw_clim_ts, by = c('month', 'hwname')) %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
df_all
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0))
ts_all <- df_subset_ts %>%
filter(hwname == paste0('hw', year)) %>%
left_join(hw_clim_ts, by = c('month', 'hwname')) %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0))
head(ts_all)
df_subset_ts <- bind_rows(
get_hw_spatial_average(hwname = 'hw2003', varname = 'LST'),
get_hw_spatial_average(hwname = 'hw2010', varname = 'LST'),
get_hw_spatial_average(hwname = 'hw2018', varname = 'LST')
)
hw_clim_ts <- df_subset_ts %>%
group_by(month, hwname) %>%
summarise(clim_obs = mean(obs, na.rm = T),
clim_sim = mean(sim, na.rm = T))
ts_all <- df_subset_ts %>%
filter(hwname == paste0('hw', year)) %>%
left_join(hw_clim_ts, by = c('month', 'hwname')) %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0))
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
geom_line(aes(y = sim, colour = factor(year_of_hw)), show.legend = F, linetype = 'dashed') +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0)) +
title('')
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
geom_line(aes(y = sim, colour = factor(year_of_hw)), show.legend = F, linetype = 'dashed') +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0))
get_hw_spatial_average <- function(hwnames, varname){
load(paste0(input_dir, 'df_comb___', varname, '.RData'))  # <--- df_comb
hw_bbox <- hw_polygons %>% filter(hw == hwname) %>% st_bbox()
df_subsetHW <- df_comb %>%
filter(x >= hw_bbox$xmin & x <= hw_bbox$xmax) %>%
filter(y >= hw_bbox$ymin & y <= hw_bbox$ymax)
rm(df_comb)
df_subset_ts <- df_subsetHW  %>%
group_by(year, month) %>%
summarise(obs = mean(obs, na.rm = T), sim = mean(sim, na.rm = T)) %>%
mutate(time = as.Date(paste(year, month, '15', sep = '-'), '%Y-%M-%d'),
varname = varname,
hwname = hwname)
return(df_subset_ts)
}
df_subset_1 <- get_hw_spatial_average(hwname = 'hw2003', varname = 'LAI')
df_subset_2 <- get_hw_spatial_average(hwname = 'hw2010', varname = 'LAI')
df_subset_3 <- get_hw_spatial_average(hwname = 'hw2018', varname = 'LAI')
df_subset_ts <- bind_rows(df_subset_1, df_subset_2, df_subset_3)
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
geom_line(aes(y = sim, colour = factor(year_of_hw)), show.legend = F, linetype = 'dashed') +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0))
hw_clim_ts <- df_subset_ts %>%
group_by(month, hwname) %>%
summarise(clim_obs = mean(obs, na.rm = T),
clim_sim = mean(sim, na.rm = T))
ts_all <- df_subset_ts %>%
filter(hwname == paste0('hw', year)) %>%
left_join(hw_clim_ts, by = c('month', 'hwname')) %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
geom_line(aes(y = sim, colour = factor(year_of_hw)), show.legend = F, linetype = 'dashed') +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0))
df_subset_ts <- bind_rows(df_subset_1, df_subset_2, df_subset_3)
hw_clim_ts <- df_subset_ts %>%
group_by(month, hwname) %>%
summarise(clim_obs = mean(obs, na.rm = T),
clim_sim = mean(sim, na.rm = T))
ts_all <- df_subset_ts %>%
filter(hwname == paste0('hw', year)) %>%
left_join(hw_clim_ts, by = c('month', 'hwname')) %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
geom_line(aes(y = sim, colour = factor(year_of_hw)), show.legend = F, linetype = 'dashed') +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0))
get_hw_spatial_average <- function(hwname, varname){
load(paste0(input_dir, 'df_comb___', varname, '.RData'))  # <--- df_comb
hw_bbox <- hw_polygons %>% filter(hw == hwname) %>% st_bbox()
df_subsetHW <- df_comb %>%
filter(x >= hw_bbox$xmin & x <= hw_bbox$xmax) %>%
filter(y >= hw_bbox$ymin & y <= hw_bbox$ymax)
rm(df_comb)
df_subset_ts <- df_subsetHW  %>%
group_by(year, month) %>%
summarise(obs = mean(obs, na.rm = T), sim = mean(sim, na.rm = T)) %>%
mutate(time = as.Date(paste(year, month, '15', sep = '-'), '%Y-%M-%d'),
varname = varname,
hwname = hwname)
return(df_subset_ts)
}
df_subset_1 <- get_hw_spatial_average(hwname = 'hw2003', varname = 'LAI')
df_subset_2 <- get_hw_spatial_average(hwname = 'hw2010', varname = 'LAI')
df_subset_3 <- get_hw_spatial_average(hwname = 'hw2018', varname = 'LAI')
df_subset_ts <- bind_rows(df_subset_1, df_subset_2, df_subset_3)
hw_clim_ts <- df_subset_ts %>%
group_by(month, hwname) %>%
summarise(clim_obs = mean(obs, na.rm = T),
clim_sim = mean(sim, na.rm = T))
ts_all <- df_subset_ts %>%
filter(hwname == paste0('hw', year)) %>%
left_join(hw_clim_ts, by = c('month', 'hwname')) %>%
rename(year_of_hw = year) %>%
left_join(data.frame(year_of_hw = c(2003, 2010, 2018),
month_of_hw = c(7, 8, 8)), by = "year_of_hw")
ggplot(ts_all, aes(x = month)) +
geom_vline(aes(xintercept = month_of_hw), size = 2) +
geom_line(aes(y = clim_obs)) +
geom_line(aes(y = clim_sim), linetype = 'dashed') +
geom_line(aes(y = obs, colour = factor(year_of_hw)), show.legend = F) +
geom_line(aes(y = sim, colour = factor(year_of_hw)), show.legend = F, linetype = 'dashed') +
facet_grid(year_of_hw~.) +
scale_x_continuous(expand = c(0,0))

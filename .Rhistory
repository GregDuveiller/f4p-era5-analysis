plot_per_clim('Csa', df_lgd, 'png')
plot_per_clim('Cwa', df_lgd, 'png')
plot_per_clim <- function(sel_cz,  df_lgd, fmt = 'png'){
cz_cols <- df_lgd$cz_colours
names(cz_cols) <- df_lgd$cz_name
data <- df_all_comb %>% filter(cz_name %in% sel_cz)
g_plot1 <- ggplot(data) +
geom_point(aes(x = LAI_dif_mu, y = LST_dif_mu, fill = monthS),
colour = 'grey35', shape = 21) +
geom_hline(yintercept = 0, colour = 'grey20') +
geom_vline(xintercept = 0, colour = 'grey20') +
scale_fill_gradientn('Month', colours = cols_mon) +
scale_y_continuous('Bias in LST (ERA - obs)') +
scale_x_continuous('Bias in LAI (ERA - obs)') +
theme(legend.position = 'bottom',
legend.key.width = unit(1.5, units = 'cm')) +
guides(fill = guide_colourbar(title.position = 'top', title.hjust = 0.5))
g_plot2 <- ggplot(data) +
geom_point(aes(x = LAI_dif_mu, y = LST_obs_mu - 273.15, fill = LST_dif_mu),
colour = 'grey35', shape = 21) +
geom_vline(xintercept = 0, colour = 'grey20') +
scale_fill_gradientn('Bias in LST (ERA - obs)', colours = cols_lst,
limits = c(-1,1) * max(abs(range(data$LST_dif_mu, na.rm = T)))) +
scale_y_continuous('Mean LST (obs) [K]') +
scale_x_continuous('Bias in LAI (ERA - obs)') +
theme(legend.position = 'bottom',
legend.key.width = unit(1.5, units = 'cm')) +
guides(fill = guide_colourbar(title.position = 'top', title.hjust = 0.5))
g_maps <- ggplot(df_cz %>%
filter(cz_name %in% sel_cz) %>%
mutate(cz_grp = paste('Distribution of', sel_cz))) +
geom_sf(data = wmap_df_land, fill='Grey50',colour='Grey50',size=0) +
geom_sf(data = wmap_df_ocean, fill='Grey20',colour='Grey20',size=0) +
geom_tile(aes(x = x, y = y, fill = cz_name)) +
scale_fill_manual('Koppen-Geiger climate zones', values = cz_cols) +
scale_y_continuous('Latitude', expand = c(0, 0)) +
scale_x_continuous('Longitude', expand = c(0, 0)) +
ggtitle(label = paste0('Heat bias due to LAI bias over climate ', sel_cz)) +
theme(legend.position = 'none') +
guides(fill = guide_legend(title.position = 'top', nrow = 4))
g_combo <- g_maps / (g_plot1 + g_plot2) + plot_layout(nrow = 2, heights = c(2/5, 3/5 ))
ggsave(filename = paste0('LAIbias_perCZ_', sel_cz, '.', fmt),
path = out.path, plot = g_combo, width = 8,
height = 8)
}
plot_per_clim('Aw',  df_lgd, 'png')
plot_per_clim('Cfa', df_lgd, 'png')
plot_per_clim('Csa', df_lgd, 'png')
plot_per_clim('Cwa', df_lgd, 'png')
plot_per_clim('Af',  df_lgd, 'png')
plot_per_clim('Cfb', df_lgd, 'png')
g_maps <- ggplot(df_cz %>%
filter(cz_name %in% sel_cz) %>%
mutate(cz_grp = paste('Distribution of', sel_cz))) +
geom_sf(data = wmap_df_land, fill='Grey50',colour='Grey50',size=0) +
geom_sf(data = wmap_df_ocean, fill='Grey20',colour='Grey20',size=0) +
geom_tile(aes(x = x, y = y, fill = cz_name)) +
scale_fill_manual('Koppen-Geiger climate zones', values = cz_cols) +
scale_y_continuous('Latitude', expand = c(0, 0)) +
scale_x_continuous('Longitude', expand = c(0, 0)) +
ggtitle(label = paste0('Heat bias due to LAI bias over climate ', sel_cz)) +
theme(legend.position = 'none',title = element_text(hjust = 0.5)) +
guides(fill = guide_legend(title.position = 'top', nrow = 4))
g_maps
g_maps <- ggplot(df_cz %>%
filter(cz_name %in% sel_cz) %>%
mutate(cz_grp = paste('Distribution of', sel_cz))) +
geom_sf(data = wmap_df_land, fill='Grey50',colour='Grey50',size=0) +
geom_sf(data = wmap_df_ocean, fill='Grey20',colour='Grey20',size=0) +
geom_tile(aes(x = x, y = y, fill = cz_name)) +
scale_fill_manual('Koppen-Geiger climate zones', values = cz_cols) +
scale_y_continuous('Latitude', expand = c(0, 0)) +
scale_x_continuous('Longitude', expand = c(0, 0)) +
ggtitle(label = paste0('Heat bias due to LAI bias over climate ', sel_cz)) +
theme(legend.position = 'none',title = element_text(vjust = 0.5)) +
guides(fill = guide_legend(title.position = 'top', nrow = 4))
g_maps
plot_per_clim <- function(sel_cz,  df_lgd, fmt = 'png'){
cz_cols <- df_lgd$cz_colours
names(cz_cols) <- df_lgd$cz_name
data <- df_all_comb %>% filter(cz_name %in% sel_cz)
g_plot1 <- ggplot(data) +
geom_point(aes(x = LAI_dif_mu, y = LST_dif_mu, fill = monthS),
colour = 'grey35', shape = 21) +
geom_hline(yintercept = 0, colour = 'grey20') +
geom_vline(xintercept = 0, colour = 'grey20') +
scale_fill_gradientn('Month', colours = cols_mon) +
scale_y_continuous('Bias in LST (ERA - obs)') +
scale_x_continuous('Bias in LAI (ERA - obs)') +
theme(legend.position = 'top',
legend.key.width = unit(1.5, units = 'cm')) +
guides(fill = guide_colourbar(title.position = 'top', title.hjust = 0.5))
g_plot2 <- ggplot(data) +
geom_point(aes(x = LAI_dif_mu, y = LST_obs_mu - 273.15, fill = LST_dif_mu),
colour = 'grey35', shape = 21) +
geom_vline(xintercept = 0, colour = 'grey20') +
scale_fill_gradientn('Bias in LST (ERA - obs)', colours = cols_lst,
limits = c(-1,1) * max(abs(range(data$LST_dif_mu, na.rm = T)))) +
scale_y_continuous('Mean LST (obs) [K]') +
scale_x_continuous('Bias in LAI (ERA - obs)') +
theme(legend.position = 'top',
legend.key.width = unit(1.5, units = 'cm')) +
guides(fill = guide_colourbar(title.position = 'top', title.hjust = 0.5))
g_maps <- ggplot(df_cz %>%
filter(cz_name %in% sel_cz) %>%
mutate(cz_grp = paste('Distribution of', sel_cz))) +
geom_sf(data = wmap_df_land, fill='Grey50',colour='Grey50',size=0) +
geom_sf(data = wmap_df_ocean, fill='Grey20',colour='Grey20',size=0) +
geom_tile(aes(x = x, y = y, fill = cz_name)) +
scale_fill_manual('Koppen-Geiger climate zones', values = cz_cols) +
scale_y_continuous('Latitude', expand = c(0, 0)) +
scale_x_continuous('Longitude', expand = c(0, 0)) +
ggtitle(label = paste0('Heat bias due to LAI bias over climate ', sel_cz)) +
theme(legend.position = 'none') +
guides(fill = guide_legend(title.position = 'top', nrow = 4))
g_combo <- g_maps / (g_plot1 + g_plot2) + plot_layout(nrow = 2, heights = c(2/5, 3/5 ))
ggsave(filename = paste0('LAIbias_perCZ_', sel_cz, '.', fmt),
path = out.path, plot = g_combo, width = 8,
height = 8)
}
plot_per_clim('Af',  df_lgd, 'png')
plot_per_clim('Aw',  df_lgd, 'png')
plot_per_clim('Cfa', df_lgd, 'png')
plot_per_clim('Cfb', df_lgd, 'png')
plot_per_clim('Csa', df_lgd, 'png')
plot_per_clim('Cwa', df_lgd, 'png')
library(ggplot2)
library(dplyr)
library(tidyr)
# set output path
out.path <- 'results/vardf4comparison'
# get some general ancillary info
load('results/ancillary_info/df_KG_climatezones.RData') #  'df_cz' and 'df_lgd'
LAI_files <- list.files(path = 'data/r_data_frames',
pattern = 'theia_025', full.names = T)
(load('../../jeodpp/eos_user_home/F4P/df_albedo_ERA5l_025_2015.RData'))
head(df)
df_ERA <- df
(load('../../jeodpp/eos_user_home/F4P/df_albedo_NASA_025_wsa_nir_2015.RData'))
head(df)
ggplot(df) + geom_raster(aes(x = x, y = y, fill = wsa_nir_QAok)) + scale_fill_viridis_c()
ggplot(df %>% month == 5) + geom_raster(aes(x = x, y = y, fill = wsa_nir_QAok)) + scale_fill_viridis_c()
ggplot(df %>% filter(month == 5)) + geom_raster(aes(x = x, y = y, fill = wsa_nir_QAok)) + scale_fill_viridis_c()
ggplot(df_ERA %>% filter(month == 5)) + geom_raster(aes(x = x, y = y, fill = alnid)) + scale_fill_viridis_c()
df_comb <- left_join(df, df_ERA, by = c('x', 'y', 'year', 'month'))
head(df_comb)
ggplot(df_comb %>% filter(month == 5)) + geom_raster(aes(x = x, y = y, fill = wsa_nir_QAok-alnid)) + scale_fill_gradientn(colours = brewer.rdbu(9), limits = c(-0.05, 0.05))
load('results/vardf4comparison/df_LST_comb.RData', verbose = T)
head(df_LST_comb)
library(dplyr)
library(tidyr)
path_obs <- '/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace/'
path_sim <- '/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace/'
# clim data
data_path <- '/Users/greg/work/data/external_datasets/climate_zones/Map_KG-Global/'
file.symlink(to = 'data/input_data/climate_zones', from = data_path)
# vctr data
data_path <- '/Volumes/home/work/data/external_datasets/WorldVector/'
file.symlink(to = 'data/input_data/world_vectors', from = data_path)
years <- 2010:2017
list.files(path_obs)
years <- 2010:2017
spres <- '025'
files_sim <- list.files(path = path_sim, pattern = paste0('albedo_ERA5l_', spres), full.names = T)
files_sim
df_obs <-
files_obs <- list.files(path = path_obs, pattern = paste0('albedo_NASA_', spres, '_wsa_vis'), full.names = T) #"df_i_025"
files_obs
path_sim <- '/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace'
path_obs <- '/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace'
path_sim <- '/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace'
years <- 2010:2017
spres <- '025'
ifile <- files_obs[1]
ifile
load(ifile)
(load(ifile))
load(ifile); df_obs <- df
files_obs
src_obs <- 'NASA'
src_sim <- 'ERA5l'
src_obs <- 'NASA'
src_sim <- 'ERA5l'
years <- 2010:2017
spres <- '025'
files_obs <- list.files(path = path_obs, pattern = paste0('albedo_', src_obs, '_', spres, '_wsa_vis'), full.names = T) #"df_i_025"
files_sim <- list.files(path = path_sim, pattern = paste0('albedo_', src_sim, '_', spres), full.names = T)
ifile
load(gsub(ifile, pattern = 'NASA_025_wsa_vis', replacement = 'ERA5l_025')); df_SMra <- df
gsub(ifile, pattern = 'NASA_025_wsa_vis', replacement = 'ERA5l_025')
head(df_obs)
load(gsub(ifile, pattern = 'NASA_025_wsa_vis', replacement = 'ERA5l_025')); df_sim <- df
head(df_sim)
varDFname_obs <- 'wsa_vis_QAall'
varDFname_sim <- 'aluvd'
df_dum <- df_obs %>%
#filter(`nobs` > 5) %>%
select(x, y, year, month, matches(varDFname_obs))
df_dum
head(df_dum)
require(ggplot2)
ggplot(df_dum) + geom_raster(aes(x = x, y = y, fill = wsa_vis_QAall)) + scale_fill_brewer()
ggplot(df_dum) + geom_raster(aes(x = x, y = y, fill = wsa_vis_QAall)) + scale_fill_viridis_c()
ggplot(df_dum %>% fitler(month == 6)) + geom_raster(aes(x = x, y = y, fill = wsa_vis_QAall)) + scale_fill_viridis_c()
ggplot(df_dum %>% filter(month == 6)) + geom_raster(aes(x = x, y = y, fill = wsa_vis_QAall)) + scale_fill_viridis_c()
head(df_sim)
df_dum <- df_obs %>%
#filter(`nobs` > 5) %>%
select(x, y, year, month, matches(varDFname_obs)) %>%
# need to rotate cold months in Southern Hemisphere
mutate(monthS = ifelse(sign(y) < 0, (month + 6) %% 12, month))  %>%
mutate(monthS = ifelse(monthS == 0, 12, monthS)) %>%
left_join(df_sim %>%
select(x, y, year, month, matches(varDFname_sim)) %>%
# need to rotate cold months in Southern Hemisphere
mutate(monthS = ifelse(sign(y) < 0, (month + 6) %% 12, month),
monthS = ifelse(monthS == 0, 12, monthS)),
by = c("x", "y", "month", "monthS", "year"))
head(df_dum)
ggplot(df_dum) + geom_density2d(aes(x = wsa_vis_QAall, y = aluvd)) + facet_wrap(~monthS)
ggplot(df_dum %>% filter(month == 6)) + geom_raster(aes(x = x, y = y, fill = wsa_vis_QAall)) + scale_fill_viridis_c()
ggplot(df_dum %>% filter(month == 6)) + geom_raster(aes(x = x, y = y, fill = aluvd)) + scale_fill_viridis_c()
iris
head(iris)
df_dum %>%
rename(obs = matches(varDFname_obs), sim = matches(varDFname_sim))
df_dum %>%
rename(obs = matches(varDFname_obs), sim = matches(varDFname_sim)) %>% tibble()
df_dum <- df_dum %>%     rename(obs = matches(varDFname_obs),
sim = matches(varDFname_sim)) %>%
mutate(bias = sim - obs)
ggplot(df_dum %>% filter(month == 6)) + geom_raster(aes(x = x, y = y, fill = bias)) + scale_fill_viridis_c()
ggplot(df_dum %>% filter(month == 6)) + geom_raster(aes(x = x, y = y, fill = bias)) + scale_fill_viridis_c(limits = c(-0.01, 0.01))
ggplot(df_dum %>% filter(month == 6)) + geom_raster(aes(x = x, y = y, fill = bias)) + scale_fill_viridis_c()
ggplot(df_dum) + geom_bin2d(aes(x = wsa_vis_QAall, y = aluvd)) + facet_wrap(~monthS)
ggplot(df_dum) + geom_bin2d(aes(x = obs, y = sim)) + facet_wrap(~monthS)
source('~/work/workspace/f4p-era5-analysis/code/harvest___input_df_albedo.R')
target_var
target_var
source('~/work/workspace/f4p-era5-analysis/code/harvest___input_df_albedo.R')
save('df_comb', file = paste0(out_path,'/df_comb___', target_var, '.RData'), compress = T, compression_level = 9)
ifile
load(ifile); df_obs <- df
head(df_obs)
max(df_obs)
max(df_obs$year)
max(df_obs$y)
varDFname_obs <- 'wsa_vis_QAall'
varDFname_sim <- 'aluvd'
xtraLbl_obs <- 'wsa_vis'
# work on RS file
load(ifile); df_obs <- df
# get equivalent from the Reanalysis
load(gsub(ifile,
pattern = paste0(src_obs, '_', spres, '_', xtraLbl_obs),
replacement = 'ERA5l_025')); df_sim <- df
# get equivalent from the Reanalysis
load(gsub(ifile,
pattern = paste0(src_obs, '_', spres, '_', xtraLbl_obs),
replacement =  paste0(src_sim, '_', spres))); df_sim <- df
head(df_dum)
df_dum2 <- df_dum %>%   mutate(time = as.Date(x = paste(year, monthS, '15', sep = '-')))
head(df_dum2)
files_obs <- list.files(path = path_obs, pattern = paste0('albedo_', src_obs, '_', spres, '_', xtraLbl_obs), full.names = T)
files_obs
ifile
# get equivalent from the Reanalysis
load(gsub(basename(ifile),
pattern = paste0(src_obs, '_', spres, '_', xtraLbl_obs),
replacement =  paste0(src_sim, '_', spres))); df_sim <- df
basename(ifile)
# get equivalent from the Reanalysis
load(gsub(paste0(path_sim, '/', basename(ifile)),
pattern = paste0(src_obs, '_', spres, '_', xtraLbl_obs),
replacement =  paste0(src_sim, '_', spres))); df_sim <- df
paste0(src_obs, '_', spres, '_', xtraLbl_obs)
target_var <- 'albedo'
xtrLbl_obs <- 'wsa_vis'
xtrLbl_obs_full = NULL
paste0(target_var, '_', src_obs, '_', spres, xtrLbl_obs_full)
target_var
xtrLbl_obs
xtrLbl_obs_full
if(xtrLbl_obs){xtrLbl_obs_full <- paste0('_', xtrLbl_obs)} else {xtrLbl_obs_full = NULL}
if(xtrLbl_obs){xtrLbl_sim_full <- paste0('_', xtrLbl_sim)} else {xtrLbl_sim_full = NULL}
if(xtrLbl_obs){xtrLbl_obs_full <- paste0('_', xtrLbl_obs)} else {xtrLbl_obs_full = NULL}
if(xtrLbl_sim){xtrLbl_sim_full <- paste0('_', xtrLbl_sim)} else {xtrLbl_sim_full = NULL}
xtrLbl_sim
if(exists(xtrLbl_sim)){xtrLbl_sim_full <- paste0('_', xtrLbl_sim)} else {xtrLbl_sim_full = NULL}
xtrLbl_sim
exists(xtrLbl_sim)
xtrLbl_sim
xtrLbl_obs
xtrLbl_sim_full
xtrLbl_obs_full
xtrLbl_obs
xtrLbl_obs
if(xtrLbl_obs != NULL){xtrLbl_obs_full <- paste0('_', xtrLbl_obs)} else {xtrLbl_obs_full = NULL}
if(is.null(xtrLbl_obs)){xtrLbl_obs_full <- paste0('_', xtrLbl_obs)} else {xtrLbl_obs_full = NULL}
xtrLbl_obs
xtrLbl_obs_full
xtrLbl_obs
if(!is.null(xtrLbl_sim)){xtrLbl_sim_full <- paste0('_', xtrLbl_sim)} else {xtrLbl_sim_full = NULL}
xtrLbl_sim <- NULL
if(!is.null(xtrLbl_obs)){xtrLbl_obs_full <- paste0('_', xtrLbl_obs)} else {xtrLbl_obs_full = NULL}
if(!is.null(xtrLbl_sim)){xtrLbl_sim_full <- paste0('_', xtrLbl_sim)} else {xtrLbl_sim_full = NULL}
files_obs <- list.files(path = path_obs, pattern = paste0(target_var, '_', src_obs, '_', spres, xtrLbl_obs_full), full.names = T)
files_sim <- list.files(path = path_sim, pattern = paste0(target_var, '_', src_sim, '_', spres, xtrLbl_sim_full), full.names = T)
files_obs
files_sim
print(paste(" ----> finished with ", target_var, xtrLbl_obs))
print(paste(" ----> finished with:", target_var, xtrLbl_obs))
print(paste(" ----> finished with:", target_var, xtrLbl_obs, "<----"))
paste0(out_path,'/df_comb___', target_var, xtrLbl_obs_full, '.RData')
print(paste(' |> working on file:', basename(ifile)))
print(paste(' |> working on file:', basename(ifile)), ' <| ')
print(paste(' |> working on file:', basename(ifile), ' <| '))
path_obs
get_df_comb <- function(target_var, xtrLbl_obs = NULL, xtrLbl_sim = NULL,
src_obs, src_sim, varDFname_obs, varDFname_sim,
out_path, path_obs, path_sim, spres = '025'){
out_path <- 'data/inter_data/df_obs_vs_sim'
dir.create(out_path, showWarnings = F, recursive = T)
if(!is.null(xtrLbl_obs)){xtrLbl_obs_full <- paste0('_', xtrLbl_obs)} else {xtrLbl_obs_full = NULL}
if(!is.null(xtrLbl_sim)){xtrLbl_sim_full <- paste0('_', xtrLbl_sim)} else {xtrLbl_sim_full = NULL}
files_obs <- list.files(path = path_obs, pattern = paste0(target_var, '_', src_obs, '_', spres, xtrLbl_obs_full), full.names = T)
files_sim <- list.files(path = path_sim, pattern = paste0(target_var, '_', src_sim, '_', spres, xtrLbl_sim_full), full.names = T)
df_comb <- data.frame()
for(ifile in files_obs){
print(paste(' |> working on file:', basename(ifile), ' <| '))
# work on RS file
load(ifile)
df_obs <- df
# get equivalent from the Reanalysis
load(gsub(paste0(path_sim, '/', basename(ifile)),
pattern = paste0(src_obs, '_', spres, xtrLbl_obs_full),
replacement =  paste0(src_sim, '_', spres, xtrLbl_sim_full)))
df_sim <- df
# select and combine
df_dum <- df_obs %>%
select(x, y, year, month, matches(varDFname_obs))
inner_join(df_sim %>% select(x, y, year, month, matches(varDFname_sim)),
by = c("x", "y", "month", "year")) %>%
rename(obs = matches(varDFname_obs),
sim = matches(varDFname_sim))
df_comb <- bind_rows(df_comb, df_dum)
}
save('df_comb', file = paste0(out_path,'/df_comb___', target_var, xtrLbl_obs_full, '.RData'))
print(paste(" ----> finished with:", target_var, xtrLbl_obs, "<----"))
}
get_df_comb(
target_var = 'albedo',
xtrLbl_obs = 'wsa_vis',
path_obs = '/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace',
path_sim = '/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace',
src_obs = 'NASA',
src_sim = 'ERA5l',
varDFname_obs = 'wsa_vis_QAall',
varDFname_sim = 'aluvd',
spres = '025')
ifile
ifile <- files_obs[1]
ifile
print(paste(' |> working on file:', basename(ifile), ' <| '))
# work on RS file
load(ifile)
df_obs <- df
# get equivalent from the Reanalysis
load(gsub(paste0(path_sim, '/', basename(ifile)),
pattern = paste0(src_obs, '_', spres, xtrLbl_obs_full),
replacement =  paste0(src_sim, '_', spres, xtrLbl_sim_full)))
df_sim <- df
varDFname_obs
# select and combine
df_dum <- df_obs %>%
select(x, y, year, month, matches(varDFname_obs)) %>%
inner_join(df_sim %>%
select(x, y, year, month, matches(varDFname_sim)),
by = c("x", "y", "month", "year")) %>%
rename(obs = matches(varDFname_obs),
sim = matches(varDFname_sim))
get_df_comb <- function(target_var, xtrLbl_obs = NULL, xtrLbl_sim = NULL,
src_obs, src_sim, varDFname_obs, varDFname_sim,
out_path, path_obs, path_sim, spres = '025'){
out_path <- 'data/inter_data/df_obs_vs_sim'
dir.create(out_path, showWarnings = F, recursive = T)
if(!is.null(xtrLbl_obs)){xtrLbl_obs_full <- paste0('_', xtrLbl_obs)} else {xtrLbl_obs_full = NULL}
if(!is.null(xtrLbl_sim)){xtrLbl_sim_full <- paste0('_', xtrLbl_sim)} else {xtrLbl_sim_full = NULL}
files_obs <- list.files(path = path_obs, pattern = paste0(target_var, '_', src_obs, '_', spres, xtrLbl_obs_full), full.names = T)
files_sim <- list.files(path = path_sim, pattern = paste0(target_var, '_', src_sim, '_', spres, xtrLbl_sim_full), full.names = T)
df_comb <- data.frame()
for(ifile in files_obs){
print(paste(' |> working on file:', basename(ifile), ' <| '))
# work on RS file
load(ifile)
df_obs <- df
# get equivalent from the Reanalysis
load(gsub(paste0(path_sim, '/', basename(ifile)),
pattern = paste0(src_obs, '_', spres, xtrLbl_obs_full),
replacement =  paste0(src_sim, '_', spres, xtrLbl_sim_full)))
df_sim <- df
# select and combine
df_dum <- df_obs %>%
select(x, y, year, month, matches(varDFname_obs)) %>%
inner_join(df_sim %>%
select(x, y, year, month, matches(varDFname_sim)),
by = c("x", "y", "month", "year")) %>%
rename(obs = matches(varDFname_obs),
sim = matches(varDFname_sim))
df_comb <- bind_rows(df_comb, df_dum)
}
save('df_comb', file = paste0(out_path,'/df_comb___', target_var, xtrLbl_obs_full, '.RData'))
print(paste(" ----> finished with:", target_var, xtrLbl_obs, "<----"))
}
get_df_comb(
target_var = 'albedo',
xtrLbl_obs = 'wsa_vis',
path_obs = '/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace',
path_sim = '/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace',
src_obs = 'NASA',
src_sim = 'ERA5l',
varDFname_obs = 'wsa_vis_QAall',
varDFname_sim = 'aluvd',
spres = '025')
out_path
head(df_sim)
dat_path <- '/eos/jeodpp/data/projects/COPERNICUSII/data'
out_path <- '/eos/jeodpp/data/projects/COPERNICUSII/transfer/greg_workspace'
source('~/work/workspace/f4p-era5-analysis/code/function___get_df_comb_std.R')
src_obs
out_path
xtrLbl_obs
xtrLbl_obs
# in case target variable has an extra (more specific label) for sim or obs
if(!is.null(xtrLbl_obs)){xtrLbl_obs_full <- paste0('_', xtrLbl_obs)} else {xtrLbl_obs_full = NULL}
if(!is.null(xtrLbl_sim)){xtrLbl_sim_full <- paste0('_', xtrLbl_sim)} else {xtrLbl_sim_full = NULL}
xtrLbl_obs_full
xtrLbl_sim_full
# in case the name of the target variable is different in either sim or obs
if(is.null(target_var_obs)){target_var_obs <- target_var}
target_var_obs
target_var_obs = NULL
target_var_sim = NULL
# in case the name of the target variable is different in either sim or obs
if(is.null(target_var_obs)){target_var_obs <- target_var}
if(is.null(target_var_sim)){target_var_sim <- target_var}
# get list of files
files_obs <- list.files(path = path_obs, pattern = paste0(target_var_obs, '_', src_obs, '_', spres, xtrLbl_obs_full), full.names = T)
files_obs
src_sim
target_var_sim
# get equivalent from the Reanalysis
jfile <- gsub(paste0(path_sim, '/', basename(ifile)),
pattern = paste0(target_var_obs, '_', src_obs, '_', spres, xtrLbl_obs_full),
replacement =  paste0(target_var_sim, '_', src_sim, '_', spres, xtrLbl_sim_full))
jfile
path_obs
file.exists(jfile)
require(ggplot2)
load('/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace/df_comb___albedo_wsa_nir.RData')
head(df_comb)
head(df_all_comb)
head(df)
load('/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace/df_comb___albedo_wsa_nir.RData', verbose=T)
head(df_comb)
ggplot(df_comb %>% filter(month == 1, year == 2001)) + geom_raster(aes(x=x,y=y, fill = obs)) + scale_color_viridis_c()
ggplot(df_comb %>% filter(month == 6, year == 2001)) + geom_raster(aes(x=x,y=y, fill = obs)) + scale_color_viridis_c()
ggplot(df_comb %>% filter(month == 6, year == 2001)) + geom_raster(aes(x=x,y=y, fill = obs)) + scale_fill_viridis_c()
ggplot(df_comb %>% filter(month == 3, year == 2001)) + geom_raster(aes(x=x,y=y, fill = obs)) + scale_fill_viridis_c()
ggplot(df_comb %>% filter(month == 2, year == 2001)) + geom_raster(aes(x=x,y=y, fill = obs)) + scale_fill_viridis_c()
ggplot(df_comb %>% filter(month == 12, year == 2001)) + geom_raster(aes(x=x,y=y, fill = obs)) + scale_fill_viridis_c()
load('/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace/df_comb___albedo_bsa_nir.RData', verbose=T)
head(df_comb)
?matches
load('/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace/df_comb___LST.RData', verbose=T)
head(df_comb)
load('/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace/df_comb___SM.RData', verbose=T)
head(df_comb)
ggplot(df_comb %>% filter(month == 2, year == 2001)) + geom_raster(aes(x=x,y=y, fill = obs)) + scale_fill_viridis_c()
ggplot(df_comb %>% filter(month == 5, year == 2011)) + geom_raster(aes(x=x,y=y, fill = obs)) + scale_fill_viridis_c()
ggplot(df_comb %>% filter(month == 5, year == 2018)) + geom_raster(aes(x=x,y=y, fill = obs)) + scale_fill_viridis_c()
load('/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace/df_comb___LAI.RData', verbose=T)
head(df_comb)
ggplot(df_comb %>% filter(month == 5, year == 2011)) + geom_raster(aes(x=x,y=y, fill = obs)) + scale_fill_viridis_c()
ggplot(df_comb %>% filter(month == 5, year == 2010)) + geom_raster(aes(x=x,y=y, fill = obs)) + scale_fill_viridis_c()
load('/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace/df_comb___LST.RData', verbose=T)
ggplot(df_comb %>% filter(month == 5, year == 2010)) + geom_raster(aes(x=x,y=y, fill = obs)) + scale_fill_viridis_c()
ggplot(df_comb %>% filter(month == 5, year == 2010)) + geom_raster(aes(x=x,y=y, fill = sim)) + scale_fill_viridis_c()
col_pal <- RColorBrewer::brewer.pal(9, 'RdBu')
ggplot(df_comb %>% filter(month == 5, year == 2010)) + geom_raster(aes(x=x,y=y, fill = sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-10,10), oob = squish())
require(scales)
ggplot(df_comb %>% filter(month == 5, year == 2010)) + geom_raster(aes(x=x,y=y, fill = sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-10,10), oob = squish())
ggplot(df_comb %>% filter(month == 5, year == 2010)) + geom_raster(aes(x=x,y=y, fill = sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-10,10), oob = squish)
head(df_comb)
ggplot(df_comb %>% filter(month == 5, year == 2010)) + geom_raster(aes(x=x,y=y, fill = obs - sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-10,10), oob = squish)
ggplot(df_comb %>% filter(month == 5, year == 2010)) + geom_raster(aes(x=x,y=y, fill = obs - sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-1,1) * max_val, oob = squish)
max_val = 20
ggplot(df_comb %>% filter(month == 5, year == 2010)) + geom_raster(aes(x=x,y=y, fill = obs - sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-1,1) * max_val, oob = squish)
ggplot(df_comb %>% filter(month == 9, year == 2010)) + geom_raster(aes(x=x,y=y, fill = obs - sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-1,1) * max_val, oob = squish)
ggplot(df_comb %>% filter(month == 7, year == 2018)) + geom_raster(aes(x=x,y=y, fill = obs - sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-1,1) * max_val, oob = squish)
max_val = 10
ggplot(df_comb %>% filter(month == 7, year == 2018)) + geom_raster(aes(x=x,y=y, fill = obs - sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-1,1) * max_val, oob = squish)
ggplot(df_comb %>% filter(month == 7, year == 2003)) + geom_raster(aes(x=x,y=y, fill = obs - sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-1,1) * max_val, oob = squish)
load('/Users/greg/work/jeodpp/eos_COPERNICUSII/greg_workspace/df_comb___albedo_wsa_vis.RData', verbose=T)
ggplot(df_comb %>% filter(month == 7, year == 2003)) + geom_raster(aes(x=x,y=y, fill = obs - sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-1,1) * max_val, oob = squish)
head(df_comb)
max_val <- 0.05
ggplot(df_comb %>% filter(month == 7, year == 2003)) + geom_raster(aes(x=x,y=y, fill = obs - sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-1,1) * max_val, oob = squish)
max_val <- 0.02
ggplot(df_comb %>% filter(month == 7, year == 2013)) + geom_raster(aes(x=x,y=y, fill = obs - sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-1,1) * max_val, oob = squish)
max_val <- 0.03
ggplot(df_comb %>% filter(month == 4, year == 2013)) + geom_raster(aes(x=x,y=y, fill = obs - sim)) + scale_fill_gradientn(colours = col_pal, limits = c(-1,1) * max_val, oob = squish)
